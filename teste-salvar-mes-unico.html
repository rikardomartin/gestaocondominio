<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste: Salvar Apenas Mes Ativo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 { color: #2c3e50; }
        h2 { color: #3498db; margin-top: 0; }
        .status { 
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #2980b9; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .payment-record {
            background: #f8f9fa;
            padding: 10px;
            margin: 5px 0;
            border-left: 3px solid #3498db;
        }
    </style>
</head>
<body>
    <h1>üß™ Teste: Salvar Status Apenas para Mes Ativo</h1>

    <div class="test-section">
        <h2>üìã Objetivo do Teste</h2>
        <p>Verificar se ao marcar um apartamento como PAGO em Janeiro/2026, o sistema:</p>
        <ul>
            <li>‚úÖ Cria registro APENAS para Janeiro/2026</li>
            <li>‚úÖ NAO afeta outros meses (Dezembro, Novembro, etc.)</li>
            <li>‚úÖ Usa appState.activeYear e appState.activeMonth</li>
            <li>‚úÖ Cria payment record em vez de atualizar apartment.status</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>üîß Status da Correcao</h2>
        <div id="fixStatus"></div>
    </div>

    <div class="test-section">
        <h2>üéØ Periodo Ativo</h2>
        <div id="activePeriod"></div>
        <button onclick="setPeriod('2026', '01')">Definir: Janeiro/2026</button>
        <button onclick="setPeriod('2026', '02')">Definir: Fevereiro/2026</button>
    </div>

    <div class="test-section">
        <h2>üíæ Simular Salvamento</h2>
        <button onclick="testSave('pago')">Marcar como PAGO</button>
        <button onclick="testSave('pendente')">Marcar como PENDENTE</button>
        <button onclick="testSave('reciclado')">Marcar como RECICLADO</button>
        <div id="saveResult"></div>
    </div>

    <div class="test-section">
        <h2>üìä Registros de Pagamento</h2>
        <button onclick="showPayments()">Mostrar Pagamentos</button>
        <div id="paymentsList"></div>
    </div>

    <script type="module">
        // Importar Firebase
        import './firebase-config.js';
        import './firebase-database.js';

        // Verificar se a correcao foi carregada
        window.addEventListener('load', () => {
            checkFix();
            checkActivePeriod();
        });

        function checkFix() {
            const statusDiv = document.getElementById('fixStatus');
            
            if (typeof saveApartmentStatusNew === 'function') {
                const funcStr = saveApartmentStatusNew.toString();
                
                if (funcStr.includes('appState.activeYear') && funcStr.includes('appState.activeMonth')) {
                    statusDiv.innerHTML = '<div class="status success">‚úÖ Correcao carregada! Funcao verifica periodo ativo.</div>';
                } else {
                    statusDiv.innerHTML = '<div class="status error">‚ùå Funcao antiga ainda ativa. Limpe o cache!</div>';
                }
            } else {
                statusDiv.innerHTML = '<div class="status error">‚ùå Funcao saveApartmentStatusNew nao encontrada!</div>';
            }
        }

        function checkActivePeriod() {
            const periodDiv = document.getElementById('activePeriod');
            
            if (typeof appState !== 'undefined') {
                periodDiv.innerHTML = `
                    <div class="status info">
                        <strong>Ano Ativo:</strong> ${appState.activeYear || 'NAO DEFINIDO'}<br>
                        <strong>Mes Ativo:</strong> ${appState.activeMonth || 'NAO DEFINIDO'}
                    </div>
                `;
            } else {
                periodDiv.innerHTML = '<div class="status error">‚ùå appState nao encontrado!</div>';
            }
        }

        window.setPeriod = function(year, month) {
            if (typeof appState !== 'undefined') {
                appState.activeYear = year;
                appState.activeMonth = month;
                checkActivePeriod();
                
                const periodDiv = document.getElementById('activePeriod');
                periodDiv.innerHTML += '<div class="status success">‚úÖ Periodo atualizado!</div>';
            }
        };

        window.testSave = async function(status) {
            const resultDiv = document.getElementById('saveResult');
            resultDiv.innerHTML = '<div class="status info">‚è≥ Testando salvamento...</div>';

            // Verificar periodo ativo
            if (!appState.activeYear || !appState.activeMonth) {
                resultDiv.innerHTML = '<div class="status error">‚ùå Defina o periodo ativo primeiro!</div>';
                return;
            }

            // Simular apartamento selecionado
            if (!appState.selectedApartamento) {
                appState.selectedApartamento = {
                    id: 'test-apt-101',
                    numero: '101',
                    condominioId: 'test-cond',
                    blocoId: 'test-bloco',
                    tipo: 'apartamento'
                };
            }

            // Simular selecao de status no modal
            const radioButtons = document.querySelectorAll('input[name="aptStatus"]');
            radioButtons.forEach(radio => {
                if (radio.value === status) {
                    radio.checked = true;
                }
            });

            try {
                // Chamar funcao corrigida
                await saveApartmentStatusNew();
                
                resultDiv.innerHTML = `
                    <div class="status success">
                        ‚úÖ Salvamento concluido!<br>
                        <strong>Status:</strong> ${status}<br>
                        <strong>Periodo:</strong> ${appState.activeMonth}/${appState.activeYear}
                    </div>
                `;
                
                // Mostrar pagamentos apos salvar
                setTimeout(showPayments, 500);
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">‚ùå Erro: ${error.message}</div>`;
            }
        };

        window.showPayments = function() {
            const listDiv = document.getElementById('paymentsList');
            
            if (!appState.payments || !appState.payments.condominio) {
                listDiv.innerHTML = '<div class="status info">Nenhum pagamento registrado ainda.</div>';
                return;
            }

            const payments = appState.payments.condominio.filter(p => 
                p.apartamentoId === 'test-apt-101'
            );

            if (payments.length === 0) {
                listDiv.innerHTML = '<div class="status info">Nenhum pagamento para apartamento 101.</div>';
                return;
            }

            let html = '<h3>Pagamentos do Apartamento 101:</h3>';
            payments.forEach(p => {
                html += `
                    <div class="payment-record">
                        <strong>Data:</strong> ${p.date || `${p.ano}-${p.mes}`}<br>
                        <strong>Status:</strong> ${p.status}<br>
                        <strong>Observacao:</strong> ${p.observacao || 'Nenhuma'}
                    </div>
                `;
            });

            listDiv.innerHTML = html;
        };
    </script>

    <!-- Criar inputs hidden para simular modal -->
    <div style="display: none;">
        <input type="radio" name="aptStatus" value="pendente">
        <input type="radio" name="aptStatus" value="pago">
        <input type="radio" name="aptStatus" value="reciclado">
        <input type="radio" name="aptStatus" value="acordo">
        <textarea id="apartmentObservations"></textarea>
        <input id="houseResidentName" type="text">
    </div>
</body>
</html>
