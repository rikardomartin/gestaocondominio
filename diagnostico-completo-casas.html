<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico Completo - Casas</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .login-section {
            background: #f0f0f0;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .login-section input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .user-info {
            background: #d4edda;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
        button {
            background: #007bff;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        #resultado {
            margin-top: 20px;
            font-family: monospace;
            font-size: 13px;
            white-space: pre-wrap;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            max-height: 600px;
            overflow-y: auto;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        .hidden { display: none; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            background: white;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border: 1px solid #ddd;
        }
        th {
            background: #f0f0f0;
            font-weight: bold;
        }
        .bloco-correto { background: #d4edda; }
        .bloco-incorreto { background: #f8d7da; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico Completo - Estrutura de Casas</h1>
        
        <div class="login-section" id="loginSection">
            <h3>üîê Login</h3>
            <input type="email" id="emailInput" placeholder="Email" value="admin@condominio.com">
            <input type="password" id="passwordInput" placeholder="Senha">
            <button onclick="fazerLogin()">Entrar</button>
        </div>

        <div class="user-info" id="userInfo">
            <strong>‚úÖ Logado:</strong> <span id="userEmail"></span>
        </div>

        <div id="mainContent" class="hidden">
            <button onclick="diagnosticar()">üîç Diagnosticar Estrutura</button>
            <div id="resultado"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth,
            signInWithEmailAndPassword,
            onAuthStateChanged
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getFirestore, 
            collection, 
            getDocs,
            query, 
            where
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDw1XIkVyMMPfGLCeF4GpMJ6kEZ8HeeuF8",
            authDomain: "gestaodoscondominios.firebaseapp.com",
            projectId: "gestaodoscondominios",
            storageBucket: "gestaodoscondominios.firebasestorage.app",
            messagingSenderId: "20572242752",
            appId: "1:20572242752:web:c1b533c1bb905e81b0f0a5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let currentUser = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('userInfo').style.display = 'block';
                document.getElementById('mainContent').classList.remove('hidden');
                document.getElementById('userEmail').textContent = user.email;
            }
        });

        window.fazerLogin = async function() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                alert('Erro: ' + error.message);
            }
        };

        window.diagnosticar = async function() {
            const resultado = document.getElementById('resultado');
            resultado.innerHTML = '<span class="info">üîç Analisando estrutura...</span>\n\n';

            try {
                // Buscar todos os condom√≠nios
                const condQuery = query(collection(db, 'condominios'), where('active', '==', true));
                const condSnap = await getDocs(condQuery);

                const estruturaEsperada = {
                    'Ayres': { blocos: 29, casas: [{ bloco: 1, qtd: 2 }, { bloco: 30, qtd: 3 }] },
                    'Vidal': { blocos: 19, casas: [{ bloco: 20, qtd: 4 }] },
                    'Taroni': { blocos: 15, casas: [{ bloco: 1, qtd: 3 }] },
                    'Speranza': { blocos: 25, casas: [{ bloco: 26, qtd: 4 }] },
                    'Destri': { blocos: 26, casas: [{ bloco: 27, qtd: 2 }, { bloco: 28, qtd: 3 }] },
                    'Vacaria': { blocos: 24, casas: [{ bloco: 25, qtd: 4 }] }
                };

                for (const condDoc of condSnap.docs) {
                    const condData = condDoc.data();
                    const nomeSimples = condData.nome.replace('Condom√≠nio ', '');
                    
                    if (!estruturaEsperada[nomeSimples]) continue;

                    resultado.innerHTML += `\n${'='.repeat(80)}\n`;
                    resultado.innerHTML += `<span class="info">üìç ${condData.nome}</span>\n`;
                    resultado.innerHTML += `${'='.repeat(80)}\n\n`;

                    const esperado = estruturaEsperada[nomeSimples];

                    // Buscar blocos
                    const blocosQuery = query(
                        collection(db, 'blocos'),
                        where('condominioId', '==', condDoc.id)
                    );
                    const blocosSnap = await getDocs(blocosQuery);
                    
                    resultado.innerHTML += `<span class="info">üìä BLOCOS ENCONTRADOS: ${blocosSnap.size}</span>\n`;
                    resultado.innerHTML += `<span class="info">üìä BLOCOS ESPERADOS: ${esperado.blocos} (apartamentos)</span>\n\n`;

                    // Listar todos os blocos
                    const blocos = [];
                    blocosSnap.forEach(doc => {
                        const b = doc.data();
                        blocos.push({
                            id: doc.id,
                            numero: b.numero,
                            nome: b.nome,
                            tipo: b.tipo || 'apartamentos',
                            totalApartamentos: b.totalApartamentos || 16
                        });
                    });

                    blocos.sort((a, b) => a.numero - b.numero);

                    // Verificar blocos de casas
                    const blocosCasasEsperados = esperado.casas.map(c => c.bloco);
                    
                    resultado.innerHTML += `<span class="warning">üè† BLOCOS DE CASAS ESPERADOS: ${blocosCasasEsperados.join(', ')}</span>\n\n`;

                    // Tabela de blocos
                    resultado.innerHTML += `<table>`;
                    resultado.innerHTML += `<tr><th>N¬∫</th><th>Nome</th><th>Tipo</th><th>Unidades</th><th>Status</th></tr>`;
                    
                    blocos.forEach(bloco => {
                        const isBlocoCasas = blocosCasasEsperados.includes(bloco.numero);
                        const deveExistir = bloco.numero <= esperado.blocos || isBlocoCasas;
                        const classe = deveExistir ? 'bloco-correto' : 'bloco-incorreto';
                        const status = deveExistir ? '‚úÖ OK' : '‚ùå N√ÉO DEVERIA EXISTIR';
                        
                        resultado.innerHTML += `<tr class="${classe}">`;
                        resultado.innerHTML += `<td>${bloco.numero}</td>`;
                        resultado.innerHTML += `<td>${bloco.nome}</td>`;
                        resultado.innerHTML += `<td>${bloco.tipo}</td>`;
                        resultado.innerHTML += `<td>${bloco.totalApartamentos}</td>`;
                        resultado.innerHTML += `<td>${status}</td>`;
                        resultado.innerHTML += `</tr>`;
                    });
                    
                    resultado.innerHTML += `</table>\n\n`;

                    // Buscar casas
                    const casasQuery = query(
                        collection(db, 'apartamentos'),
                        where('condominioId', '==', condDoc.id),
                        where('tipo', '==', 'casa')
                    );
                    const casasSnap = await getDocs(casasQuery);

                    resultado.innerHTML += `<span class="info">üè† CASAS ENCONTRADAS: ${casasSnap.size}</span>\n`;
                    
                    const totalCasasEsperadas = esperado.casas.reduce((sum, c) => sum + c.qtd, 0);
                    resultado.innerHTML += `<span class="info">üè† CASAS ESPERADAS: ${totalCasasEsperadas}</span>\n\n`;

                    // Agrupar casas por bloco
                    const casasPorBloco = {};
                    casasSnap.forEach(doc => {
                        const casa = doc.data();
                        const blocoId = casa.blocoId;
                        if (!casasPorBloco[blocoId]) {
                            casasPorBloco[blocoId] = [];
                        }
                        casasPorBloco[blocoId].push({
                            numero: casa.numero,
                            blocoNome: casa.blocoNome
                        });
                    });

                    // Mostrar casas por bloco
                    for (const [blocoId, casas] of Object.entries(casasPorBloco)) {
                        const bloco = blocos.find(b => b.id === blocoId);
                        const blocoNumero = bloco ? bloco.numero : '?';
                        const blocoNome = casas[0].blocoNome;
                        
                        const esperadoNestBloco = esperado.casas.find(c => c.bloco === blocoNumero);
                        const qtdEsperada = esperadoNestBloco ? esperadoNestBloco.qtd : 0;
                        
                        const correto = casas.length === qtdEsperada;
                        const classe = correto ? 'success' : 'error';
                        
                        resultado.innerHTML += `<span class="${classe}">  üì¶ ${blocoNome}: ${casas.length} casa(s) ${correto ? '‚úÖ' : '‚ùå (esperado: ' + qtdEsperada + ')'}</span>\n`;
                        casas.forEach(casa => {
                            resultado.innerHTML += `     ‚Ä¢ ${casa.numero}\n`;
                        });
                    }

                    // Verificar blocos faltando
                    esperado.casas.forEach(esperadoCasa => {
                        const blocoExiste = blocos.some(b => b.numero === esperadoCasa.bloco);
                        if (!blocoExiste) {
                            resultado.innerHTML += `<span class="error">  ‚ùå FALTA: Bloco ${esperadoCasa.bloco} (${esperadoCasa.qtd} casas)</span>\n`;
                        }
                    });

                    resultado.innerHTML += `\n`;
                }

                resultado.innerHTML += `\n${'='.repeat(80)}\n`;
                resultado.innerHTML += `<span class="success">‚úÖ DIAGN√ìSTICO CONCLU√çDO</span>\n`;

            } catch (error) {
                resultado.innerHTML += `<span class="error">‚ùå Erro: ${error.message}</span>\n`;
                console.error(error);
            }
        };
    </script>
</body>
</html>
