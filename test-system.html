<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Testes - CondomÃ­nio</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #2563eb; text-align: center; margin-bottom: 30px; }
        h2 { color: #1e40af; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
        .test-section {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #e2e8f0;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            font-weight: 500;
            width: 100%;
        }
        button:hover { background: #1d4ed8; }
        button:disabled { background: #94a3b8; cursor: not-allowed; }
        .btn-success { background: #059669; }
        .btn-success:hover { background: #047857; }
        .btn-warning { background: #d97706; }
        .btn-warning:hover { background: #b45309; }
        .btn-danger { background: #dc2626; }
        .btn-danger:hover { background: #b91c1c; }
        .status {
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            font-weight: 500;
        }
        .success { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .error { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
        .info { background: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }
        .warning { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
        .test-result {
            background: #f1f5f9;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            border-left: 4px solid #64748b;
        }
        .test-result.success { border-left-color: #059669; }
        .test-result.error { border-left-color: #dc2626; }
        .progress {
            background: #e2e8f0;
            border-radius: 10px;
            height: 8px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-bar {
            background: #2563eb;
            height: 100%;
            transition: width 0.3s ease;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #2563eb;
            display: block;
        }
        .stat-label {
            font-size: 12px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        code {
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #1e293b;
        }
        .user-list {
            background: #f0f9ff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e0f2fe;
        }
        .user-item:last-child { border-bottom: none; }
        .user-info { flex: 1; }
        .user-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        .status-working { background: #dcfce7; color: #166534; }
        .status-failed { background: #fef2f2; color: #dc2626; }
        .status-unknown { background: #f1f5f9; color: #64748b; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Sistema de Testes - GestÃ£o Condominial</h1>
        
        <div class="info">
            <strong>ğŸ¯ Objetivo:</strong> Diagnosticar e resolver problemas de autenticaÃ§Ã£o no sistema.
        </div>

        <div class="stats" id="stats">
            <div class="stat-card">
                <span class="stat-number" id="totalTests">0</span>
                <span class="stat-label">Testes Executados</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="successTests">0</span>
                <span class="stat-label">Sucessos</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="failedTests">0</span>
                <span class="stat-label">Falhas</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="workingUsers">0</span>
                <span class="stat-label">UsuÃ¡rios OK</span>
            </div>
        </div>

        <div class="test-grid">
            <div class="test-section">
                <h2>ğŸ” Testes de AutenticaÃ§Ã£o</h2>
                <button onclick="testFirebaseConnection()">ğŸ”¥ Testar ConexÃ£o Firebase</button>
                <button onclick="testAllKnownUsers()">ğŸ‘¥ Testar UsuÃ¡rios Conhecidos</button>
                <button onclick="createAndTestUser()">â• Criar UsuÃ¡rio de Teste</button>
                <button onclick="testLoginFlow()">ğŸ”„ Testar Fluxo de Login</button>
            </div>

            <div class="test-section">
                <h2>ğŸ¢ Testes de Sistema</h2>
                <button onclick="testFirestoreRules()">ğŸ“‹ Testar Regras Firestore</button>
                <button onclick="testDataStructure()">ğŸ—ï¸ Testar Estrutura de Dados</button>
                <button onclick="testPermissions()">ğŸ”’ Testar PermissÃµes</button>
                <button onclick="runFullSystemTest()">ğŸš€ Teste Completo do Sistema</button>
            </div>
        </div>

        <div class="test-section">
            <h2>ğŸ“Š Resultados dos Testes</h2>
            <div class="progress">
                <div class="progress-bar" id="progressBar" style="width: 0%"></div>
            </div>
            <div id="results"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ‘¥ Status dos UsuÃ¡rios</h2>
            <div class="user-list" id="userList">
                <div class="info">Clique em "Testar UsuÃ¡rios Conhecidos" para verificar o status</div>
            </div>
        </div>

        <div class="test-section">
            <h2>ğŸ”§ AÃ§Ãµes de CorreÃ§Ã£o</h2>
            <button class="btn-success" onclick="createWorkingAdmin()">âœ… Criar Admin Funcional</button>
            <button class="btn-warning" onclick="resetUserProfiles()">ğŸ”„ Recriar Perfis de UsuÃ¡rio</button>
            <button class="btn-danger" onclick="clearAllData()">ğŸ—‘ï¸ Limpar Dados de Teste</button>
        </div>
    </div>

    <script type="module">
        import { 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            updateProfile,
            signOut
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            doc, 
            setDoc, 
            getDoc, 
            collection, 
            getDocs,
            deleteDoc
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { auth, db } from './firebase-config.js';

        let testStats = {
            total: 0,
            success: 0,
            failed: 0,
            workingUsers: 0
        };

        const knownUsers = [
            { email: 'admin.condominio@gmail.com', password: '123456', name: 'Admin Gmail', role: 'admin' },
            { email: 'operador.condominio@gmail.com', password: '123456', name: 'Operador Gmail', role: 'operator' },
            { email: 'viewer.condominio@gmail.com', password: '123456', name: 'Viewer Gmail', role: 'viewer' },
            { email: 'admin@condominio.com', password: '123456', name: 'Admin Antigo', role: 'admin' },
            { email: 'operador@condominio.com', password: '123456', name: 'Operador Antigo', role: 'operator' },
            { email: 'viewer@condominio.com', password: '123456', name: 'Viewer Antigo', role: 'viewer' }
        ];

        window.testFirebaseConnection = async function() {
            addResult('ğŸ”¥ Testando conexÃ£o com Firebase...', 'info');
            
            try {
                // Testar Auth
                const authTest = auth.currentUser !== undefined;
                addResult(`Auth: ${authTest ? 'âœ… Conectado' : 'âŒ Falha'}`, authTest ? 'success' : 'error');
                
                // Testar Firestore
                const testDoc = doc(db, 'test', 'connection');
                await setDoc(testDoc, { timestamp: new Date(), test: true });
                const docSnap = await getDoc(testDoc);
                const firestoreTest = docSnap.exists();
                addResult(`Firestore: ${firestoreTest ? 'âœ… Conectado' : 'âŒ Falha'}`, firestoreTest ? 'success' : 'error');
                
                // Limpar teste
                await deleteDoc(testDoc);
                
                updateStats(authTest && firestoreTest);
                
            } catch (error) {
                addResult(`âŒ Erro na conexÃ£o: ${error.message}`, 'error');
                updateStats(false);
            }
        };

        window.testAllKnownUsers = async function() {
            addResult('ğŸ‘¥ Testando todos os usuÃ¡rios conhecidos...', 'info');
            
            const userResults = [];
            let workingCount = 0;
            
            for (const user of knownUsers) {
                try {
                    addResult(`Testando ${user.email}...`, 'info');
                    
                    const userCredential = await signInWithEmailAndPassword(auth, user.email, user.password);
                    await signOut(auth);
                    
                    userResults.push({ ...user, status: 'working', uid: userCredential.user.uid });
                    workingCount++;
                    addResult(`âœ… ${user.name}: Login OK`, 'success');
                    
                } catch (error) {
                    userResults.push({ ...user, status: 'failed', error: error.code });
                    addResult(`âŒ ${user.name}: ${error.code}`, 'error');
                }
                
                updateStats(true);
            }
            
            testStats.workingUsers = workingCount;
            updateStatsDisplay();
            updateUserList(userResults);
            
            addResult(`ğŸ“Š Resumo: ${workingCount}/${knownUsers.length} usuÃ¡rios funcionando`, 
                     workingCount > 0 ? 'success' : 'error');
        };

        window.createAndTestUser = async function() {
            const email = 'teste.sistema.condominio@gmail.com';
            const password = '123456';
            const name = 'UsuÃ¡rio Teste Sistema';
            const role = 'admin';
            
            addResult('â• Criando usuÃ¡rio de teste...', 'info');
            
            try {
                // Criar usuÃ¡rio
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Atualizar perfil
                await updateProfile(user, { displayName: name });
                
                // Criar documento no Firestore
                await setDoc(doc(db, 'users', user.uid), {
                    name: name,
                    email: email,
                    role: role,
                    createdAt: new Date(),
                    createdBy: 'test-system',
                    active: true
                });
                
                // Testar login
                await signOut(auth);
                await signInWithEmailAndPassword(auth, email, password);
                await signOut(auth);
                
                addResult(`âœ… UsuÃ¡rio criado e testado: ${email}`, 'success');
                addResult(`ğŸ‰ Use este usuÃ¡rio para acessar o sistema!`, 'success');
                
                updateStats(true);
                testStats.workingUsers++;
                updateStatsDisplay();
                
            } catch (error) {
                if (error.code === 'auth/email-already-in-use') {
                    // Testar se o usuÃ¡rio existente funciona
                    try {
                        await signInWithEmailAndPassword(auth, email, password);
                        await signOut(auth);
                        addResult(`âœ… UsuÃ¡rio jÃ¡ existe e funciona: ${email}`, 'success');
                        updateStats(true);
                    } catch (loginError) {
                        addResult(`âŒ UsuÃ¡rio existe mas login falha: ${loginError.code}`, 'error');
                        updateStats(false);
                    }
                } else {
                    addResult(`âŒ Erro ao criar usuÃ¡rio: ${error.code}`, 'error');
                    updateStats(false);
                }
            }
        };

        window.testLoginFlow = async function() {
            addResult('ğŸ”„ Testando fluxo completo de login...', 'info');
            
            // Usar o primeiro usuÃ¡rio que funciona ou criar um novo
            let testEmail = 'teste.sistema.condominio@gmail.com';
            let testPassword = '123456';
            
            try {
                // 1. Testar login
                addResult('1/4 Testando login...', 'info');
                const userCredential = await signInWithEmailAndPassword(auth, testEmail, testPassword);
                const user = userCredential.user;
                
                // 2. Verificar perfil no Firestore
                addResult('2/4 Verificando perfil no Firestore...', 'info');
                const profileDoc = await getDoc(doc(db, 'users', user.uid));
                const hasProfile = profileDoc.exists();
                
                if (!hasProfile) {
                    addResult('3/4 Criando perfil automaticamente...', 'info');
                    await setDoc(doc(db, 'users', user.uid), {
                        name: user.displayName || 'UsuÃ¡rio Teste',
                        email: user.email,
                        role: 'admin',
                        createdAt: new Date(),
                        createdBy: 'auto-test',
                        active: true
                    });
                }
                
                // 4. Testar logout
                addResult('4/4 Testando logout...', 'info');
                await signOut(auth);
                
                addResult('âœ… Fluxo de login completo funcionando!', 'success');
                addResult(`ğŸ¯ Use: ${testEmail} / ${testPassword}`, 'success');
                
                updateStats(true);
                
            } catch (error) {
                addResult(`âŒ Falha no fluxo de login: ${error.code}`, 'error');
                updateStats(false);
            }
        };

        window.createWorkingAdmin = async function() {
            const email = 'admin.funcional@gmail.com';
            const password = '123456';
            const name = 'Administrador Funcional';
            
            addResult('âœ… Criando administrador funcional...', 'info');
            
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                await updateProfile(user, { displayName: name });
                
                await setDoc(doc(db, 'users', user.uid), {
                    name: name,
                    email: email,
                    role: 'admin',
                    createdAt: new Date(),
                    createdBy: 'correction-system',
                    active: true
                });
                
                // Testar
                await signOut(auth);
                await signInWithEmailAndPassword(auth, email, password);
                await signOut(auth);
                
                addResult(`ğŸ‰ ADMIN FUNCIONAL CRIADO!`, 'success');
                addResult(`ğŸ“§ Email: ${email}`, 'success');
                addResult(`ğŸ”‘ Senha: ${password}`, 'success');
                addResult(`ğŸš€ Acesse: https://gestaodoscondominios.web.app`, 'success');
                
                updateStats(true);
                
            } catch (error) {
                if (error.code === 'auth/email-already-in-use') {
                    addResult(`âš ï¸ Admin jÃ¡ existe, testando...`, 'warning');
                    try {
                        await signInWithEmailAndPassword(auth, email, password);
                        await signOut(auth);
                        addResult(`âœ… Admin existente funciona!`, 'success');
                    } catch (e) {
                        addResult(`âŒ Admin existe mas nÃ£o funciona: ${e.code}`, 'error');
                    }
                } else {
                    addResult(`âŒ Erro: ${error.code}`, 'error');
                }
            }
        };

        // FunÃ§Ãµes auxiliares
        function addResult(message, type) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        function updateStats(success) {
            testStats.total++;
            if (success) testStats.success++;
            else testStats.failed++;
            updateStatsDisplay();
        }

        function updateStatsDisplay() {
            document.getElementById('totalTests').textContent = testStats.total;
            document.getElementById('successTests').textContent = testStats.success;
            document.getElementById('failedTests').textContent = testStats.failed;
            document.getElementById('workingUsers').textContent = testStats.workingUsers;
            
            const progress = testStats.total > 0 ? (testStats.success / testStats.total) * 100 : 0;
            document.getElementById('progressBar').style.width = `${progress}%`;
        }

        function updateUserList(users) {
            const userList = document.getElementById('userList');
            userList.innerHTML = '';
            
            users.forEach(user => {
                const div = document.createElement('div');
                div.className = 'user-item';
                div.innerHTML = `
                    <div class="user-info">
                        <strong>${user.name}</strong><br>
                        <code>${user.email}</code>
                    </div>
                    <div class="user-status status-${user.status}">
                        ${user.status === 'working' ? 'âœ… OK' : 'âŒ Falha'}
                    </div>
                `;
                userList.appendChild(div);
            });
        }

        // Outras funÃ§Ãµes de teste (implementaÃ§Ã£o bÃ¡sica)
        window.testFirestoreRules = () => addResult('ğŸ”’ Teste de regras nÃ£o implementado', 'info');
        window.testDataStructure = () => addResult('ğŸ—ï¸ Teste de estrutura nÃ£o implementado', 'info');
        window.testPermissions = () => addResult('ğŸ” Teste de permissÃµes nÃ£o implementado', 'info');
        window.runFullSystemTest = () => addResult('ğŸš€ Teste completo nÃ£o implementado', 'info');
        window.resetUserProfiles = () => addResult('ğŸ”„ Reset de perfis nÃ£o implementado', 'info');
        window.clearAllData = () => addResult('ğŸ—‘ï¸ Limpeza de dados nÃ£o implementada', 'info');

        // Inicializar
        addResult('ğŸ§ª Sistema de testes inicializado', 'info');
    </script>
</body>
</html>