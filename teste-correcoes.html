<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste das Corre√ß√µes - Sistema Condom√≠nio</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #2563eb; text-align: center; margin-bottom: 30px; }
        .test-section {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #e2e8f0;
        }
        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            font-weight: 500;
            width: 100%;
        }
        button:hover { background: #1d4ed8; }
        button:disabled { background: #94a3b8; cursor: not-allowed; }
        .btn-success { background: #059669; }
        .btn-success:hover { background: #047857; }
        .status {
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            font-weight: 500;
        }
        .success { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .error { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
        .info { background: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }
        .warning { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
        .console-log {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
        }
        .step {
            background: #f0f9ff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #0ea5e9;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Teste das Corre√ß√µes Aplicadas</h1>
        
        <div class="info">
            <strong>üéØ Objetivo:</strong> Verificar se as corre√ß√µes de permiss√µes e Service Worker funcionaram.
        </div>

        <div class="test-section">
            <h3>üîê Teste 1: Login e Cria√ß√£o de Perfil</h3>
            <button onclick="testLogin()">üöÄ Testar Login Completo</button>
            <div id="loginResult"></div>
        </div>

        <div class="test-section">
            <h3>üè¢ Teste 2: Cria√ß√£o de Estrutura</h3>
            <button onclick="testStructureCreation()">üèóÔ∏è Testar Criar Estrutura</button>
            <div id="structureResult"></div>
        </div>

        <div class="test-section">
            <h3>üìã Teste 3: Permiss√µes Firestore</h3>
            <button onclick="testFirestorePermissions()">üîí Testar Permiss√µes</button>
            <div id="permissionsResult"></div>
        </div>

        <div class="test-section">
            <h3>üßπ A√ß√£o de Limpeza</h3>
            <button class="btn-success" onclick="clearServiceWorkerCache()">üóëÔ∏è Limpar Cache do Service Worker</button>
            <div id="cacheResult"></div>
        </div>

        <div class="step">
            <h4>üìã Instru√ß√µes:</h4>
            <p>1. Execute os testes na ordem</p>
            <p>2. Verifique se n√£o h√° erros no console</p>
            <p>3. Se tudo funcionar, volte para a aplica√ß√£o principal</p>
            <p>4. <a href="https://gestaodoscondominios.web.app" target="_blank" style="color: #2563eb; font-weight: bold;">üöÄ Abrir Aplica√ß√£o Principal</a></p>
        </div>

        <div class="console-log" id="consoleLog">
            [Aguardando testes...]
        </div>
    </div>

    <script type="module">
        import { signInWithEmailAndPassword, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { doc, setDoc, getDoc, collection, addDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { auth, db } from './firebase-config.js';

        const consoleLog = document.getElementById('consoleLog');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : '#e2e8f0';
            consoleLog.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            consoleLog.scrollTop = consoleLog.scrollHeight;
        }

        window.testLogin = async function() {
            const result = document.getElementById('loginResult');
            result.innerHTML = '<div class="info">üîç Testando login...</div>';
            
            try {
                log('Iniciando teste de login...', 'info');
                
                // 1. Fazer login
                const userCredential = await signInWithEmailAndPassword(auth, 'admin@condominio.com', '123456');
                const user = userCredential.user;
                log(`‚úÖ Login bem-sucedido: ${user.email}`, 'success');
                
                // 2. Tentar criar/ler perfil
                const profileRef = doc(db, 'users', user.uid);
                
                try {
                    const profileSnap = await getDoc(profileRef);
                    if (profileSnap.exists()) {
                        log('‚úÖ Perfil encontrado no Firestore', 'success');
                    } else {
                        log('üìù Perfil n√£o existe, criando...', 'info');
                        
                        await setDoc(profileRef, {
                            name: 'Administrador Sistema',
                            email: user.email,
                            role: 'admin',
                            createdAt: new Date(),
                            createdBy: 'test-correction',
                            active: true
                        });
                        
                        log('‚úÖ Perfil criado com sucesso!', 'success');
                    }
                } catch (profileError) {
                    log(`‚ùå Erro ao acessar perfil: ${profileError.message}`, 'error');
                    throw profileError;
                }
                
                // 3. Fazer logout
                await signOut(auth);
                log('‚úÖ Logout realizado', 'success');
                
                result.innerHTML = '<div class="success">‚úÖ Teste de login passou! Sem erros de permiss√£o.</div>';
                
            } catch (error) {
                log(`‚ùå Erro no teste de login: ${error.message}`, 'error');
                result.innerHTML = `<div class="error">‚ùå Teste falhou: ${error.message}</div>`;
            }
        };

        window.testStructureCreation = async function() {
            const result = document.getElementById('structureResult');
            result.innerHTML = '<div class="info">üèóÔ∏è Testando cria√ß√£o de estrutura...</div>';
            
            try {
                log('Testando cria√ß√£o de estrutura...', 'info');
                
                // Fazer login primeiro
                await signInWithEmailAndPassword(auth, 'admin@condominio.com', '123456');
                log('‚úÖ Login para teste de estrutura', 'success');
                
                // Tentar criar um condom√≠nio de teste
                const testCondominioRef = collection(db, 'condominios');
                const testDoc = await addDoc(testCondominioRef, {
                    nome: 'Teste Condom√≠nio',
                    endereco: 'Teste Endere√ßo',
                    createdAt: new Date(),
                    createdBy: 'test-system'
                });
                
                log(`‚úÖ Condom√≠nio de teste criado: ${testDoc.id}`, 'success');
                
                // Fazer logout
                await signOut(auth);
                
                result.innerHTML = '<div class="success">‚úÖ Teste de estrutura passou! Permiss√µes OK para criar dados.</div>';
                
            } catch (error) {
                log(`‚ùå Erro no teste de estrutura: ${error.message}`, 'error');
                result.innerHTML = `<div class="error">‚ùå Teste falhou: ${error.message}</div>`;
            }
        };

        window.testFirestorePermissions = async function() {
            const result = document.getElementById('permissionsResult');
            result.innerHTML = '<div class="info">üîí Testando permiss√µes...</div>';
            
            try {
                log('Testando permiss√µes do Firestore...', 'info');
                
                // Login
                await signInWithEmailAndPassword(auth, 'admin@condominio.com', '123456');
                
                // Testar leitura
                const testRead = await getDoc(doc(db, 'test', 'permissions'));
                log('‚úÖ Permiss√£o de leitura OK', 'success');
                
                // Testar escrita
                await setDoc(doc(db, 'test', 'permissions'), {
                    timestamp: new Date(),
                    test: 'permissions-ok'
                });
                log('‚úÖ Permiss√£o de escrita OK', 'success');
                
                await signOut(auth);
                
                result.innerHTML = '<div class="success">‚úÖ Todas as permiss√µes funcionando!</div>';
                
            } catch (error) {
                log(`‚ùå Erro de permiss√µes: ${error.message}`, 'error');
                result.innerHTML = `<div class="error">‚ùå Problema de permiss√µes: ${error.message}</div>`;
            }
        };

        window.clearServiceWorkerCache = async function() {
            const result = document.getElementById('cacheResult');
            result.innerHTML = '<div class="info">üóëÔ∏è Limpando cache...</div>';
            
            try {
                log('Limpando cache do Service Worker...', 'info');
                
                if ('serviceWorker' in navigator) {
                    const registration = await navigator.serviceWorker.ready;
                    
                    // Desregistrar SW atual
                    await registration.unregister();
                    log('‚úÖ Service Worker desregistrado', 'success');
                    
                    // Limpar todos os caches
                    const cacheNames = await caches.keys();
                    await Promise.all(
                        cacheNames.map(cacheName => caches.delete(cacheName))
                    );
                    log(`‚úÖ ${cacheNames.length} caches removidos`, 'success');
                    
                    // Recarregar para registrar SW novamente
                    setTimeout(() => {
                        log('üîÑ Recarregando p√°gina...', 'info');
                        window.location.reload();
                    }, 2000);
                    
                    result.innerHTML = '<div class="success">‚úÖ Cache limpo! Recarregando...</div>';
                } else {
                    result.innerHTML = '<div class="warning">‚ö†Ô∏è Service Worker n√£o suportado</div>';
                }
                
            } catch (error) {
                log(`‚ùå Erro ao limpar cache: ${error.message}`, 'error');
                result.innerHTML = `<div class="error">‚ùå Erro: ${error.message}</div>`;
            }
        };

        // Inicializar
        log('üß™ Sistema de teste das corre√ß√µes inicializado', 'info');
        log('üìã Execute os testes na ordem para verificar as corre√ß√µes', 'info');
    </script>
</body>
</html>